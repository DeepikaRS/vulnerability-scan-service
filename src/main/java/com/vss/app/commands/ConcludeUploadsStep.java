package com.vss.app.commands;

import com.vss.app.model.ScanResult;
import com.vss.app.model.UploadContext;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;

@Service
public class ConcludeUploadsStep extends ScanStep {

    private final RestTemplate restTemplate = new RestTemplate();

    public ConcludeUploadsStep() {
        super();
    }

    @Override
    public void execute(UploadContext context) throws IOException {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.MULTIPART_FORM_DATA);
        headers.set("Authorization", "Bearer " + jwtToken);

        MultiValueMap<String, Object> body = new LinkedMultiValueMap<>();

        body.add("ciUploadId", context.getUploadId());

        HttpEntity<MultiValueMap<String, Object>> requestEntity = new HttpEntity<>(body, headers);

        String externalApiUrl = "https://debricked.com/api/1.0/open/finishes/dependencies/files/uploads";
        ResponseEntity<String> response = restTemplate.exchange(
                externalApiUrl,
                HttpMethod.POST,
                requestEntity,
                String.class
        );

        if (response.getStatusCode() != HttpStatus.NO_CONTENT && response.getStatusCode() != HttpStatus.OK) {
            context.setScanResult(ScanResult.builder().scanFailedMessage("Error encountered during vulnerability scan").build());
        }
        else {
            context.setScanResult(ScanResult.builder().scanInProgressMessage("Vulnerability scan is in progress").build());
        }
        next(context);
    }
}
